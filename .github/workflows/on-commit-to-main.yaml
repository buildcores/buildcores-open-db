name: Detect JSON File Changes and Call API

on:
  push:
    branches:
      - main

jobs:
  detect-json-changes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get file changes
        id: file-changes
        run: |
          # Write file lists to temporary files instead of environment variables
          # This avoids "Argument list too long" errors with large commits
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            git diff --name-status HEAD~1 HEAD | grep '^A.*\.json$' | cut -f2 > /tmp/added_files.txt || true
            git diff --name-status HEAD~1 HEAD | grep '^M.*\.json$' | cut -f2 > /tmp/modified_files.txt || true
            git diff --name-status HEAD~1 HEAD | grep '^D.*\.json$' | cut -f2 > /tmp/deleted_files.txt || true
          else
            git ls-files '*.json' > /tmp/added_files.txt
            > /tmp/modified_files.txt
            > /tmp/deleted_files.txt
          fi
          
          ADDED_COUNT=$(wc -l < /tmp/added_files.txt | tr -d ' ')
          MODIFIED_COUNT=$(wc -l < /tmp/modified_files.txt | tr -d ' ')
          DELETED_COUNT=$(wc -l < /tmp/deleted_files.txt | tr -d ' ')
          
          echo "Files to process: $ADDED_COUNT added, $MODIFIED_COUNT modified, $DELETED_COUNT deleted"

      - name: Process added and modified JSON files
        env:
          API_BASE_URL: "https://api.buildcores.com/api/open-db"
          API_KEY: "${{ secrets.BUILDCORES_OPEN_DB_API_TOKEN }}"
        run: |
          ERROR_COUNT=0
          PROCESSED=0
          
          # Process added files
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            [ ! -f "$file" ] && continue
            
            echo "Processing new file: $file..."
            
            PART_CATEGORY=$(echo "$file" | cut -d'/' -f2)
            PART_ID=$(jq -r '.opendb_id' "$file")
            DATA=$(jq -c '.' "$file")
            
            if [ "$PART_ID" != "null" ] && [ -n "$PART_ID" ]; then
              curl -s -X POST "$API_BASE_URL/create-part" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $API_KEY" \
                -d "{\"partCategory\": \"$PART_CATEGORY\", \"opendb_id\": \"$PART_ID\", \"data\": $DATA}" > /dev/null
                
              PROCESSED=$((PROCESSED + 1))
              
              # Print progress every 100 files
              if [ $((PROCESSED % 100)) -eq 0 ]; then
                echo "Progress: $PROCESSED files processed..."
              fi
            else
              echo "ERROR: File $file is missing the required opendb_id field."
              ERROR_COUNT=$((ERROR_COUNT+1))
            fi
          done < /tmp/added_files.txt
          
          # Process modified files
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            [ ! -f "$file" ] && continue
            
            echo "Processing updated file: $file..."
            
            PART_CATEGORY=$(echo "$file" | cut -d'/' -f2)
            PART_ID=$(jq -r '.opendb_id' "$file")
            DATA=$(jq -c '.' "$file")
            
            if [ "$PART_ID" != "null" ] && [ -n "$PART_ID" ]; then
              curl -s -X POST "$API_BASE_URL/update-part" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $API_KEY" \
                -d "{\"partCategory\": \"$PART_CATEGORY\", \"opendb_id\": \"$PART_ID\", \"data\": $DATA}" > /dev/null
                
              PROCESSED=$((PROCESSED + 1))
              
              if [ $((PROCESSED % 100)) -eq 0 ]; then
                echo "Progress: $PROCESSED files processed..."
              fi
            else
              echo "ERROR: File $file is missing the required opendb_id field."
              ERROR_COUNT=$((ERROR_COUNT+1))
            fi
          done < /tmp/modified_files.txt
          
          # Process deleted files
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            echo "Processing deleted file: $file..."
            
            PART_CATEGORY=$(echo "$file" | cut -d'/' -f2)
            
            git checkout HEAD~1 -- "$file" 2>/dev/null
            if [ -f "$file" ]; then
              PART_ID=$(jq -r '.opendb_id' "$file")
              
              if [ "$PART_ID" != "null" ] && [ -n "$PART_ID" ]; then
                curl -s -X POST "$API_BASE_URL/delete-part" \
                  -H "Content-Type: application/json" \
                  -H "Authorization: Bearer $API_KEY" \
                  -d "{\"partCategory\": \"$PART_CATEGORY\", \"opendb_id\": \"$PART_ID\"}" > /dev/null
                  
                echo "API delete-part request sent for $file"
                rm "$file"
              else
                echo "ERROR: Deleted file $file was missing the required opendb_id field."
                ERROR_COUNT=$((ERROR_COUNT+1))
              fi
            else
              echo "ERROR: Could not retrieve deleted file $file from previous commit."
              ERROR_COUNT=$((ERROR_COUNT+1))
            fi
          done < /tmp/deleted_files.txt
          
          echo ""
          echo "========================================"
          echo "Processing complete: $PROCESSED files processed"
          if [ $ERROR_COUNT -gt 0 ]; then
            echo "Errors: $ERROR_COUNT"
          fi
          echo "========================================"

          if [ $ERROR_COUNT -gt 0 ]; then
            echo "ERROR: $ERROR_COUNT file(s) had issues during processing."
            exit 1
          fi
